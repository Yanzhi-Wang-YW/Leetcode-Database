```md
3673. Find Zombie Sessions
Table: app_events

+------------------+----------+
| Column Name      | Type     | 
+------------------+----------+
| event_id         | int      |
| user_id          | int      |
| event_timestamp  | datetime |
| event_type       | varchar  |
| session_id       | varchar  |
| event_value      | int      |
+------------------+----------+
event_id is the unique identifier for this table.
event_type can be app_open, click, scroll, purchase, or app_close.
session_id groups events within the same user session.
event_value represents: for purchase - amount in dollars, for scroll - pixels scrolled, for others - NULL.
Write a solution to identify zombie sessions, sessions where users appear active but show abnormal behavior patterns. A session is considered a zombie session if it meets ALL the following criteria:

The session duration is more than 30 minutes.
Has at least 5 scroll events.
The click-to-scroll ratio is less than 0.20 .
No purchases were made during the session.
Return the result table ordered by scroll_count in descending order, then by session_id in ascending order.

The result format is in the following example.

 

Example:

Input:

app_events table:

+----------+---------+---------------------+------------+------------+-------------+
| event_id | user_id | event_timestamp     | event_type | session_id | event_value |
+----------+---------+---------------------+------------+------------+-------------+
| 1        | 201     | 2024-03-01 10:00:00 | app_open   | S001       | NULL        |
| 2        | 201     | 2024-03-01 10:05:00 | scroll     | S001       | 500         |
| 3        | 201     | 2024-03-01 10:10:00 | scroll     | S001       | 750         |
| 4        | 201     | 2024-03-01 10:15:00 | scroll     | S001       | 600         |
| 5        | 201     | 2024-03-01 10:20:00 | scroll     | S001       | 800         |
| 6        | 201     | 2024-03-01 10:25:00 | scroll     | S001       | 550         |
| 7        | 201     | 2024-03-01 10:30:00 | scroll     | S001       | 900         |
| 8        | 201     | 2024-03-01 10:35:00 | app_close  | S001       | NULL        |
| 9        | 202     | 2024-03-01 11:00:00 | app_open   | S002       | NULL        |
| 10       | 202     | 2024-03-01 11:02:00 | click      | S002       | NULL        |
| 11       | 202     | 2024-03-01 11:05:00 | scroll     | S002       | 400         |
| 12       | 202     | 2024-03-01 11:08:00 | click      | S002       | NULL        |
| 13       | 202     | 2024-03-01 11:10:00 | scroll     | S002       | 350         |
| 14       | 202     | 2024-03-01 11:15:00 | purchase   | S002       | 50          |
| 15       | 202     | 2024-03-01 11:20:00 | app_close  | S002       | NULL        |
| 16       | 203     | 2024-03-01 12:00:00 | app_open   | S003       | NULL        |
| 17       | 203     | 2024-03-01 12:10:00 | scroll     | S003       | 1000        |
| 18       | 203     | 2024-03-01 12:20:00 | scroll     | S003       | 1200        |
| 19       | 203     | 2024-03-01 12:25:00 | click      | S003       | NULL        |
| 20       | 203     | 2024-03-01 12:30:00 | scroll     | S003       | 800         |
| 21       | 203     | 2024-03-01 12:40:00 | scroll     | S003       | 900         |
| 22       | 203     | 2024-03-01 12:50:00 | scroll     | S003       | 1100        |
| 23       | 203     | 2024-03-01 13:00:00 | app_close  | S003       | NULL        |
| 24       | 204     | 2024-03-01 14:00:00 | app_open   | S004       | NULL        |
| 25       | 204     | 2024-03-01 14:05:00 | scroll     | S004       | 600         |
| 26       | 204     | 2024-03-01 14:08:00 | scroll     | S004       | 700         |
| 27       | 204     | 2024-03-01 14:10:00 | click      | S004       | NULL        |
| 28       | 204     | 2024-03-01 14:12:00 | app_close  | S004       | NULL        |
+----------+---------+---------------------+------------+------------+-------------+
Output:

+------------+---------+--------------------------+--------------+
| session_id | user_id | session_duration_minutes | scroll_count |
+------------+---------+--------------------------+--------------+
| S001       | 201     | 35                       | 6            |
+------------+---------+--------------------------+--------------+
Explanation:

Session S001 (User 201):
Duration: 10:00:00 to 10:35:00 = 35 minutes (more than 30) 
Scroll events: 6 (at least 5) 
Click events: 0
Click-to-scroll ratio: 0/6 = 0.00 (less than 0.20) 
Purchases: 0 (no purchases) 
S001 is a zombie session (meets all criteria)
Session S002 (User 202):
Duration: 11:00:00 to 11:20:00 = 20 minutes (less than 30) 
Has a purchase event 
S002 is not a zombie session 
Session S003 (User 203):
Duration: 12:00:00 to 13:00:00 = 60 minutes (more than 30) 
Scroll events: 5 (at least 5) 
Click events: 1
Click-to-scroll ratio: 1/5 = 0.20 (not less than 0.20) 
Purchases: 0 (no purchases) 
S003 is not a zombie session (click-to-scroll ratio equals 0.20, needs to be less)
Session S004 (User 204):
Duration: 14:00:00 to 14:12:00 = 12 minutes (less than 30) 
Scroll events: 2 (less than 5) 
S004  is not a zombie session 
The result table is ordered by scroll_count in descending order, then by session_id in ascending order
```

```sql
# Write your MySQL query statement below
WITH count_session_duration AS (
    SELECT session_id, user_id, TIMESTAMPDIFF(MINUTE, MIN(event_timestamp), MAX(event_timestamp)) AS session_duration_minutes   
    FROM app_events 
    GROUP BY session_id, user_id 
    HAVING session_duration_minutes > 30
), 
count_scroll_events AS (
    SELECT session_id, user_id, COUNT(*) AS scroll_count       
    FROM app_events 
    WHERE event_type = "scroll" 
    GROUP BY session_id, user_id 
    HAVING scroll_count >= 5       
), 
join_table_one AS (
    SELECT count_session_duration.*, count_scroll_events.scroll_count 
    FROM count_session_duration 
    INNER JOIN count_scroll_events 
    ON count_session_duration.user_id = count_scroll_events.user_id     
),  
total_click AS (
    SELECT session_id, user_id, COUNT(*) AS num_click     
    FROM app_events 
    WHERE event_type = "click"  
    GROUP BY session_id, user_id     
), 
total_scroll AS (
    SELECT session_id, user_id, COUNT(*) AS num_scroll   
    FROM app_events 
    WHERE event_type = "scroll"  
    GROUP BY session_id, user_id     
), 
click_to_scroll AS (
    SELECT 
        COALESCE(c.user_id, s.user_id) AS user_id,
        COALESCE(c.num_click, 0) AS num_click,
        COALESCE(s.num_scroll, 0) AS num_scroll
    FROM total_click c
    LEFT JOIN total_scroll s ON c.user_id = s.user_id
    UNION 
    SELECT 
        COALESCE(c.user_id, s.user_id) AS user_id,
        COALESCE(c.num_click, 0) AS num_click,
        COALESCE(s.num_scroll, 0) AS num_scroll
    FROM total_click c
    RIGHT JOIN total_scroll s ON c.user_id = s.user_id
), 
ratio AS (
    SELECT user_id, num_click, num_scroll, (num_click / num_scroll) AS "ratio"     
    FROM click_to_scroll 
), 
check_ratio AS (
    SELECT * 
    FROM ratio 
    WHERE ratio < 0.2        
), 
join_table_two AS (
    SELECT join_table_one.* 
    FROM join_table_one 
    INNER JOIN check_ratio 
    ON join_table_one.user_id = check_ratio.user_id    
), 
contain_purchases AS (
    SELECT session_id, user_id, COUNT(*)
    FROM app_events 
    WHERE event_type = "purchase" 
    GROUP BY session_id, user_id    
) 
SELECT join_table_two.* 
FROM join_table_two 
LEFT JOIN contain_purchases 
ON join_table_two.user_id = contain_purchases.user_id 
WHERE contain_purchases.user_id IS NULL 
ORDER BY join_table_two.scroll_count DESC, join_table_two.session_id ASC              
```

```sql
# Write your MySQL query statement below
WITH count_session_duration AS (
    SELECT session_id, user_id, TIMESTAMPDIFF(MINUTE, MIN(event_timestamp), MAX(event_timestamp)) AS session_duration_minutes   
    FROM app_events 
    GROUP BY session_id, user_id 
    HAVING session_duration_minutes > 30
), 
count_scroll_events AS (
    SELECT session_id, user_id, COUNT(*) AS scroll_count       
    FROM app_events 
    WHERE event_type = "scroll" 
    GROUP BY session_id, user_id 
    HAVING scroll_count >= 5       
), 
join_table_one AS (
    SELECT count_session_duration.*, count_scroll_events.scroll_count 
    FROM count_session_duration 
    INNER JOIN count_scroll_events 
    ON count_session_duration.user_id = count_scroll_events.user_id     
), 
check_click_scroll AS (
    SELECT session_id, user_id, event_type, 
            (CASE
                WHEN event_type = "click" THEN 1
                ELSE 0 
            END) AS check_click, 
            (CASE
                WHEN event_type = "scroll" THEN 1
                ELSE 0 
            END) AS check_scroll
    FROM app_events     
), 
count_click_scroll AS (
    SELECT session_id, user_id, SUM(check_click) AS total_click, SUM(check_scroll) AS total_scroll  
    FROM check_click_scroll 
    GROUP BY session_id, user_id    
), 
click_scroll_ratio AS (
    SELECT session_id, user_id, (total_click / total_scroll) AS ratio 
    FROM count_click_scroll      
), 
check_ratio AS (
    SELECT * 
    FROM click_scroll_ratio 
    WHERE ratio < 0.2    
), 
join_table_two AS (
    SELECT join_table_one.* 
    FROM join_table_one 
    INNER JOIN check_ratio 
    ON join_table_one.user_id = check_ratio.user_id    
), 
contain_purchases AS (
    SELECT session_id, user_id, COUNT(*)
    FROM app_events 
    WHERE event_type = "purchase" 
    GROUP BY session_id, user_id    
) 
SELECT join_table_two.* 
FROM join_table_two 
LEFT JOIN contain_purchases 
ON join_table_two.user_id = contain_purchases.user_id 
WHERE contain_purchases.user_id IS NULL 
ORDER BY join_table_two.scroll_count DESC, join_table_two.session_id ASC  
```
