```md
569. Median Employee Salary 
Table: Employee

+--------------+---------+
| Column Name  | Type    |
+--------------+---------+
| id           | int     |
| company      | varchar |
| salary       | int     |
+--------------+---------+
id is the primary key (column with unique values) for this table.
Each row of this table indicates the company and the salary of one employee.
 

Write a solution to find the rows that contain the median salary of each company. While calculating the median, when you sort the salaries of the company, break the ties by id.

Return the result table in any order.

The result format is in the following example.

 

Example 1:

Input: 
Employee table:
+----+---------+--------+
| id | company | salary |
+----+---------+--------+
| 1  | A       | 2341   |
| 2  | A       | 341    |
| 3  | A       | 15     |
| 4  | A       | 15314  |
| 5  | A       | 451    |
| 6  | A       | 513    |
| 7  | B       | 15     |
| 8  | B       | 13     |
| 9  | B       | 1154   |
| 10 | B       | 1345   |
| 11 | B       | 1221   |
| 12 | B       | 234    |
| 13 | C       | 2345   |
| 14 | C       | 2645   |
| 15 | C       | 2645   |
| 16 | C       | 2652   |
| 17 | C       | 65     |
+----+---------+--------+
Output: 
+----+---------+--------+
| id | company | salary |
+----+---------+--------+
| 5  | A       | 451    |
| 6  | A       | 513    |
| 12 | B       | 234    |
| 9  | B       | 1154   |
| 14 | C       | 2645   |
+----+---------+--------+
Explanation: 
For company A, the rows sorted are as follows:
+----+---------+--------+
| id | company | salary |
+----+---------+--------+
| 3  | A       | 15     |
| 2  | A       | 341    |
| 5  | A       | 451    | <-- median
| 6  | A       | 513    | <-- median
| 1  | A       | 2341   |
| 4  | A       | 15314  |
+----+---------+--------+
For company B, the rows sorted are as follows:
+----+---------+--------+
| id | company | salary |
+----+---------+--------+
| 8  | B       | 13     |
| 7  | B       | 15     |
| 12 | B       | 234    | <-- median
| 11 | B       | 1221   | <-- median
| 9  | B       | 1154   |
| 10 | B       | 1345   |
+----+---------+--------+
For company C, the rows sorted are as follows:
+----+---------+--------+
| id | company | salary |
+----+---------+--------+
| 17 | C       | 65     |
| 13 | C       | 2345   |
| 14 | C       | 2645   | <-- median
| 15 | C       | 2645   | 
| 16 | C       | 2652   |
+----+---------+--------+
 

Follow up: Could you solve it without using any built-in or window functions
``` 

```py 
import pandas as pd 
import numpy as np 

def median_employee_salary(employee: pd.DataFrame) -> pd.DataFrame:  
    employee = employee.sort_values(['company', 'salary'])
    employee['rn'] = employee.groupby('company').cumcount() + 1  
    employee['total'] = employee.groupby('company')['id'].transform('count')  
    employee['check_median_position'] = np.where(
        (employee['total'] / 2 <= employee['rn']) & (employee['rn'] <= employee['total'] / 2 + 1), 
        1, 
        0 
    ) 
    employee = employee.loc[employee['check_median_position'] == 1, ['id', 'company', 'salary']] 
    return employee 
```


Here is the step-by-step table flowchart with the corresponding Python code for the `median_employee_salary` function.

### **Step 1: Load Input Data**
The `Employee` table is loaded into memory.

**Python Code:**
```python
# Assuming employee DataFrame is already loaded as per the function input
# employee = ...
```

**Table Output (`employee`):**
| id | company | salary |
| :--- | :--- | :--- |
| 1 | A | 2341 |
| 2 | A | 341 |
| 3 | A | 15 |
| 4 | A | 15314 |
| 5 | A | 451 |
| 6 | A | 513 |
| 7 | B | 15 |
| 8 | B | 13 |
| 9 | B | 1154 |
| 10 | B | 1345 |
| 11 | B | 1221 |
| 12 | B | 234 |
| 13 | C | 2345 |
| 14 | C | 2645 |
| 15 | C | 2645 |
| 16 | C | 2652 |
| 17 | C | 65 |

---

### **Step 2: Sort by Company and Salary**
The data is sorted by `company` (alphabetically) and `salary` (numerically/ascending). This orders the salaries from lowest to highest within each company.

**Python Code:**
```python
employee = employee.sort_values(['company', 'salary'])
```

**Table Output (`employee`):**
| id | company | salary |
| :--- | :--- | :--- |
| 3 | A | 15 |
| 2 | A | 341 |
| 5 | A | 451 |
| 6 | A | 513 |
| 1 | A | 2341 |
| 4 | A | 15314 |
| 8 | B | 13 |
| 7 | B | 15 |
| 12 | B | 234 |
| 9 | B | 1154 |
| 11 | B | 1221 |
| 10 | B | 1345 |
| 17 | C | 65 |
| 13 | C | 2345 |
| 14 | C | 2645 |
| 15 | C | 2645 |
| 16 | C | 2652 |

---

### **Step 3: Calculate Row Number and Total Count**
Two new columns are added:
1.  `rn`: A row number reset for each company (1, 2, 3...).
2.  `total`: The total number of employees in each company.

**Python Code:**
```python
employee['rn'] = employee.groupby('company').cumcount() + 1
employee['total'] = employee.groupby('company')['id'].transform('count')
```

**Table Output (`employee`):**
*(Showing representative rows)*
| id | company | salary | **rn** | **total** |
| :--- | :--- | :--- | :--- | :--- |
| 3 | A | 15 | 1 | 6 |
| 2 | A | 341 | 2 | 6 |
| 5 | A | 451 | 3 | 6 |
| 6 | A | 513 | 4 | 6 |
| 1 | A | 2341 | 5 | 6 |
| 4 | A | 15314 | 6 | 6 |
| ... | ... | ... | ... | ... |
| 17 | C | 65 | 1 | 5 |
| 13 | C | 2345 | 2 | 5 |
| 14 | C | 2645 | 3 | 5 |
| 15 | C | 2645 | 4 | 5 |
| 16 | C | 2652 | 5 | 5 |

---

### **Step 4: Identify Median Rows**
A column `check_median_position` is created. It marks rows with `1` if the row number (`rn`) falls in the middle of the dataset.
*   **Logic:** `total / 2 <= rn <= total / 2 + 1`
*   For even counts (e.g., 6), this catches rows 3 and 4.
*   For odd counts (e.g., 5), this catches row 3 (since 2.5 <= 3 <= 3.5).

**Python Code:**
```python
employee['check_median_position'] = np.where(
    (employee['total'] / 2 <= employee['rn']) & (employee['rn'] <= employee['total'] / 2 + 1), 
    1, 
    0
)
```

**Table Output (`employee`):**
| id | company | salary | rn | total | **check_median_position** |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 3 | A | 15 | 1 | 6 | 0 |
| 2 | A | 341 | 2 | 6 | 0 |
| 5 | A | 451 | 3 | 6 | **1** |
| 6 | A | 513 | 4 | 6 | **1** |
| 1 | A | 2341 | 5 | 6 | 0 |
| 4 | A | 15314 | 6 | 6 | 0 |
| ... | ... | ... | ... | ... | ... |
| 13 | C | 2345 | 2 | 5 | 0 |
| 14 | C | 2645 | 3 | 5 | **1** |
| 15 | C | 2645 | 4 | 5 | 0 |

---

### **Step 5: Filter and Select Columns**
The table is filtered to keep only rows where `check_median_position` is 1. Finally, only the relevant columns are selected.

**Python Code:**
```python
employee = employee.loc[employee['check_median_position'] == 1, ['id', 'company', 'salary']]
```

**Final Table Output (`employee`):**
| id | company | salary |
| :--- | :--- | :--- |
| 5 | A | 451 |
| 6 | A | 513 |
| 12 | B | 234 |
| 9 | B | 1154 |
| 14 | C | 2645 |  


Here is the step-by-step Microsoft Fabric Dataflow Gen2 instructions 

### Step 1: Load Data 
```md
id	company	salary
3	A	15
2	A	341
5	A	451
6	A	513
1	A	2341
4	A	15314
8	B	13
7	B	15
12	B	234
9	B	1154
11	B	1221
10	B	1345
17	C	65
13	C	2345
14	C	2645
15	C	2645
16	C	2652
```

### Step 2: Sorting the Data 
First, the code loads the data, ensures the `salary` column is a number, and then sorts everything. It sorts by `company` alphabetically, and then by `salary` from lowest to highest. **Sorting by salary is the most critical step** to ensure the middle rows actually represent the median 
#### Configuration  
- Click the dropdown arrow on the company column header and select Sort Ascending 
- Click the dropdown arrow on the salary column header and select Sort Ascending 
- Note: You should see a little "1" next to the sort arrow on company and a "2" on salary, showing the sort order 

