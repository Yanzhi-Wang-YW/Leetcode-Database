```md
3617. Find Students with Study Spiral Pattern 
Table: students

+--------------+---------+
| Column Name  | Type    |
+--------------+---------+
| student_id   | int     |
| student_name | varchar |
| major        | varchar |
+--------------+---------+
student_id is the unique identifier for this table.
Each row contains information about a student and their academic major.
Table: study_sessions

+---------------+---------+
| Column Name   | Type    |
+---------------+---------+
| session_id    | int     |
| student_id    | int     |
| subject       | varchar |
| session_date  | date    |
| hours_studied | decimal |
+---------------+---------+
session_id is the unique identifier for this table.
Each row represents a study session by a student for a specific subject.
Write a solution to find students who follow the Study Spiral Pattern - students who consistently study multiple subjects in a rotating cycle.

A Study Spiral Pattern means a student studies at least 3 different subjects in a repeating sequence
The pattern must repeat for at least 2 complete cycles (minimum 6 study sessions)
Sessions must be consecutive dates with no gaps longer than 2 days between sessions
Calculate the cycle length (number of different subjects in the pattern)
Calculate the total study hours across all sessions in the pattern
Only include students with cycle length of at least 3 subjects
Return the result table ordered by cycle length in descending order, then by total study hours in descending order.

The result format is in the following example.

 

Example:

Input:

students table:

+------------+--------------+------------------+
| student_id | student_name | major            |
+------------+--------------+------------------+
| 1          | Alice Chen   | Computer Science |
| 2          | Bob Johnson  | Mathematics      |
| 3          | Carol Davis  | Physics          |
| 4          | David Wilson | Chemistry        |
| 5          | Emma Brown   | Biology          |
+------------+--------------+------------------+
study_sessions table:

+------------+------------+------------+--------------+---------------+
| session_id | student_id | subject    | session_date | hours_studied |
+------------+------------+------------+--------------+---------------+
| 1          | 1          | Math       | 2023-10-01   | 2.5           |
| 2          | 1          | Physics    | 2023-10-02   | 3.0           |
| 3          | 1          | Chemistry  | 2023-10-03   | 2.0           |
| 4          | 1          | Math       | 2023-10-04   | 2.5           |
| 5          | 1          | Physics    | 2023-10-05   | 3.0           |
| 6          | 1          | Chemistry  | 2023-10-06   | 2.0           |
| 7          | 2          | Algebra    | 2023-10-01   | 4.0           |
| 8          | 2          | Calculus   | 2023-10-02   | 3.5           |
| 9          | 2          | Statistics | 2023-10-03   | 2.5           |
| 10         | 2          | Geometry   | 2023-10-04   | 3.0           |
| 11         | 2          | Algebra    | 2023-10-05   | 4.0           |
| 12         | 2          | Calculus   | 2023-10-06   | 3.5           |
| 13         | 2          | Statistics | 2023-10-07   | 2.5           |
| 14         | 2          | Geometry   | 2023-10-08   | 3.0           |
| 15         | 3          | Biology    | 2023-10-01   | 2.0           |
| 16         | 3          | Chemistry  | 2023-10-02   | 2.5           |
| 17         | 3          | Biology    | 2023-10-03   | 2.0           |
| 18         | 3          | Chemistry  | 2023-10-04   | 2.5           |
| 19         | 4          | Organic    | 2023-10-01   | 3.0           |
| 20         | 4          | Physical   | 2023-10-05   | 2.5           |
+------------+------------+------------+--------------+---------------+
Output:

+------------+--------------+------------------+--------------+-------------------+
| student_id | student_name | major            | cycle_length | total_study_hours |
+------------+--------------+------------------+--------------+-------------------+
| 2          | Bob Johnson  | Mathematics      | 4            | 26.0              |
| 1          | Alice Chen   | Computer Science | 3            | 15.0              |
+------------+--------------+------------------+--------------+-------------------+
Explanation:

Alice Chen (student_id = 1):
Study sequence: Math → Physics → Chemistry → Math → Physics → Chemistry
Pattern: 3 subjects (Math, Physics, Chemistry) repeating for 2 complete cycles
Consecutive dates: Oct 1-6 with no gaps > 2 days
Cycle length: 3 subjects
Total hours: 2.5 + 3.0 + 2.0 + 2.5 + 3.0 + 2.0 = 15.0 hours
Bob Johnson (student_id = 2):
Study sequence: Algebra → Calculus → Statistics → Geometry → Algebra → Calculus → Statistics → Geometry
Pattern: 4 subjects (Algebra, Calculus, Statistics, Geometry) repeating for 2 complete cycles
Consecutive dates: Oct 1-8 with no gaps > 2 days
Cycle length: 4 subjects
Total hours: 4.0 + 3.5 + 2.5 + 3.0 + 4.0 + 3.5 + 2.5 + 3.0 = 26.0 hours
Students not included:
Carol Davis (student_id = 3): Only 2 subjects (Biology, Chemistry) - doesn't meet minimum 3 subjects requirement
David Wilson (student_id = 4): Only 2 study sessions with a 4-day gap - doesn't meet consecutive dates requirement
Emma Brown (student_id = 5): No study sessions recorded
The result table is ordered by cycle_length in descending order, then by total_study_hours in descending order.
```

```py
import pandas as pd
import numpy as np

def find_study_spiral_pattern(students: pd.DataFrame, study_sessions: pd.DataFrame) -> pd.DataFrame:
    # ==========================================
    # STEP 1: PREPARE THE DATA
    # ==========================================
    # Join tables to get student names and majors next to their sessions
    df = pd.merge(study_sessions, students, on='student_id', how='inner')
    
    # CRITICAL: Ensure dates are actual datetime objects, not strings
    df['session_date'] = pd.to_datetime(df['session_date'])
    
    # Sort strictly by Student and Date so we can check the order correctly
    df = df.sort_values(by=['student_id', 'session_date'])

    # ==========================================
    # STEP 2: DEFINE STUDY "BLOCKS" (Gap Analysis)
    # ==========================================
    # We need to group consecutive sessions. A new block starts if:
    # 1. It's a different student
    # 2. OR the gap between sessions is > 2 days
    
    # Calculate days since the previous session for this student
    df['prev_date'] = df.groupby('student_id')['session_date'].shift(1)
    df['days_gap'] = (df['session_date'] - df['prev_date']).dt.days.fillna(0)
    
    # Create a boolean flag: True if this row starts a new block
    # (Note: We use .fillna(True) on the student check to handle the very first row)
    is_new_student = df['student_id'] != df['student_id'].shift(1)
    is_long_gap = df['days_gap'] > 2
    
    # Create a unique ID for each block using cumulative sum
    df['block_id'] = (is_new_student | is_long_gap).cumsum()
    
    # ==========================================
    # STEP 3: FILTER VALID BLOCKS
    # ==========================================
    # The requirement is "at least 2 cycles of 3 subjects", so we need 6+ rows.
    # Calculate the size of each block
    block_sizes = df.groupby('block_id').size()
    
    # Get the list of block_ids that are big enough
    valid_block_ids = block_sizes[block_sizes >= 6].index
    
    # Filter the main dataframe to keep only these valid blocks
    df_valid = df[df['block_id'].isin(valid_block_ids)].copy()

    # ==========================================
    # STEP 4: PATTERN RECOGNITION (The Logic)
    # ==========================================
    # We define a helper function that takes ONE block (one student's consecutive sessions)
    # and checks if it fits a spiral pattern.
    
    def check_for_spiral(group):
        # 1. Get the list of subjects in order
        actual_subjects = group['subject'].tolist()
        n_sessions = len(actual_subjects)
        total_hours = group['hours_studied'].sum()
        
        # 2. Test possible cycle lengths (from 3 up to half the total sessions)
        max_possible_length = n_sessions // 2
        
        for length in range(3, max_possible_length + 1):
            
            # --- THE GUESS ---
            # Take the first 'length' items (e.g., first 3) as our guess
            pattern_guess = actual_subjects[:length]
            
            # Check: Does this guess have 'length' UNIQUE subjects? 
            # (Prompt requires 3 different subjects, not just 3 items)
            if len(set(pattern_guess)) != length:
                continue
            
            # --- THE PREDICTION ---
            # Create what the sequence SHOULD look like if this pattern repeats perfectly
            repeats_needed = (n_sessions // length) + 1
            predicted_sequence = (pattern_guess * repeats_needed)[:n_sessions]
            
            # --- THE COMPARE ---
            # If the actual list matches our prediction exactly, we found it!
            if actual_subjects == predicted_sequence:
                return pd.Series({
                    'cycle_length': length,
                    'total_study_hours': total_hours
                })
        
        return None # No pattern found for this block

    # Apply this function to every block
    # (If df_valid is empty, return empty result immediately to avoid errors)
    if df_valid.empty:
        return pd.DataFrame(columns=['student_id', 'student_name', 'major', 'cycle_length', 'total_study_hours'])

    results = df_valid.groupby(['student_id', 'student_name', 'major', 'block_id']).apply(check_for_spiral)
    
    # ==========================================
    # STEP 5: FINAL CLEANUP
    # ==========================================
    # The result has MultiIndex and maybe NaN rows (failed patterns). Clean it up.
    
    # Drop rows where no pattern was found
    results = results.dropna().reset_index()
    
    # Sort: Longest cycle first, then most hours
    results = results.sort_values(by=['cycle_length', 'total_study_hours'], ascending=[False, False])
    
    # Select only the columns asked for in the output
    final_columns = ['student_id', 'student_name', 'major', 'cycle_length', 'total_study_hours']
    
    return results[final_columns] 
```
