```md
1322. Ads Performance  
Table: Ads

+---------------+---------+
| Column Name   | Type    |
+---------------+---------+
| ad_id         | int     |
| user_id       | int     |
| action        | enum    |
+---------------+---------+
(ad_id, user_id) is the primary key (combination of columns with unique values) for this table.
Each row of this table contains the ID of an Ad, the ID of a user, and the action taken by this user regarding this Ad.
The action column is an ENUM (category) type of ('Clicked', 'Viewed', 'Ignored').
 

A company is running Ads and wants to calculate the performance of each Ad.

Performance of the Ad is measured using Click-Through Rate (CTR) where:


Write a solution to find the ctr of each Ad. Round ctr to two decimal points.

Return the result table ordered by ctr in descending order and by ad_id in ascending order in case of a tie.

The result format is in the following example.

 

Example 1:

Input: 
Ads table:
+-------+---------+---------+
| ad_id | user_id | action  |
+-------+---------+---------+
| 1     | 1       | Clicked |
| 2     | 2       | Clicked |
| 3     | 3       | Viewed  |
| 5     | 5       | Ignored |
| 1     | 7       | Ignored |
| 2     | 7       | Viewed  |
| 3     | 5       | Clicked |
| 1     | 4       | Viewed  |
| 2     | 11      | Viewed  |
| 1     | 2       | Clicked |
+-------+---------+---------+
Output: 
+-------+-------+
| ad_id | ctr   |
+-------+-------+
| 1     | 66.67 |
| 3     | 50.00 |
| 2     | 33.33 |
| 5     | 0.00  |
+-------+-------+
Explanation: 
for ad_id = 1, ctr = (2/(2+1)) * 100 = 66.67
for ad_id = 2, ctr = (1/(1+2)) * 100 = 33.33
for ad_id = 3, ctr = (1/(1+1)) * 100 = 50.00
for ad_id = 5, ctr = 0.00, Note that ad_id = 5 has no clicks or views.
Note that we do not care about Ignored Ads
```

```py
import pandas as pd

def ads_performance(ads: pd.DataFrame) -> pd.DataFrame:
    clicked = ads.copy() 
    clicked = clicked.loc[clicked['action'] == 'Clicked'] 
    customTransformations1 = clicked

    viewed = ads.copy() 
    viewed = viewed.loc[viewed['action'] == 'Viewed'] 
    customTransformations2 = viewed

    all_ad_id = ads.copy()
    all_ad_id = all_ad_id[['ad_id']]
    customTransformations3 = all_ad_id

    customTransformations3 = customTransformations3.drop_duplicates(subset=['ad_id'])   
    customTransformations4 = customTransformations3 

    customTransformations1 = customTransformations1.groupby('ad_id').size().reset_index(name='clicked_cnt') 
    customTransformations5 = customTransformations1

    customTransformations2 = customTransformations2.groupby('ad_id').size().reset_index(name='viewed_cnt')  
    customTransformations6 = customTransformations2
    # Join customTransformations5 and customTransformations6
    join1 = pd.merge(customTransformations5, customTransformations6, left_on=["ad_id"], right_on=["ad_id"], how="outer")
    join1['clicked_cnt'] = join1['clicked_cnt'].fillna(0)
    join1['viewed_cnt'] = join1['viewed_cnt'].fillna(0)

    join1['ctr'] = join1['clicked_cnt'] / (join1['clicked_cnt'] + join1['viewed_cnt'])  
    customTransformations7 = join1
    # Join customTransformations4 and customTransformations7
    join2 = pd.merge(customTransformations4, customTransformations7, left_on=["ad_id"], right_on=["ad_id"], how="left")


    join2 = join2[['ad_id', 'ctr']] 
    customTransformations8 = join2

    customTransformations8['ctr'] = customTransformations8['ctr'].fillna(value=0) 
    customTransformations9 = customTransformations8

    customTransformations9['ctr'] = (customTransformations9['ctr'] * 10000 + 0.5).astype(int) / 10000.0  
    customTransformations10 = customTransformations9


    customTransformations10['ctr'] = customTransformations10['ctr'] * 100 
    customTransformations11 = customTransformations10 

    customTransformations11 = customTransformations11.sort_values(['ctr', 'ad_id'], ascending=[False, True]) 
    customTransformations12 = customTransformations11 
    output = customTransformations12 
    return output 
```

Here is the step-by-step table flowchart with the corresponding Python code, using the specific input data provided.

### **Input Data**
| ad_id | user_id | action |
| :--- | :--- | :--- |
| 1 | 1 | Clicked |
| 2 | 2 | Clicked |
| 3 | 3 | Viewed |
| 5 | 5 | Ignored |
| 1 | 7 | Ignored |
| 2 | 7 | Viewed |
| 3 | 5 | Clicked |
| 1 | 4 | Viewed |
| 2 | 11 | Viewed |
| 1 | 2 | Clicked |

---

### **Step 1: Filter for Clicks**
The data is filtered to keep only rows where the action is 'Clicked'. Rows with 'Viewed' or 'Ignored' are removed.

**Python Code:**
```python
clicked = ads.copy() 
clicked = clicked.loc[clicked['action'] == 'Clicked'] 
```

**Table Output (`clicked`):**
| ad_id | user_id | action |
| :--- | :--- | :--- |
| 1 | 1 | Clicked |
| 2 | 2 | Clicked |
| 3 | 5 | Clicked |
| 1 | 2 | Clicked |

---

### **Step 2: Filter for Views**
The data is filtered to keep only rows where the action is 'Viewed'.

**Python Code:**
```python
viewed = ads.copy() 
viewed = viewed.loc[viewed['action'] == 'Viewed'] 
```

**Table Output (`viewed`):**
| ad_id | user_id | action |
| :--- | :--- | :--- |
| 3 | 3 | Viewed |
| 2 | 7 | Viewed |
| 1 | 4 | Viewed |
| 2 | 11 | Viewed |

---

### **Step 3: Extract Unique Ad IDs**
The function extracts all unique `ad_id` values from the original dataset to ensure every ad is represented in the final report, even if it was never clicked or viewed (like Ad 5).

**Python Code:**
```python
all_ad_id = ads[['ad_id']]
customTransformations3 = all_ad_id.drop_duplicates(subset=['ad_id'])
```

**Table Output (`customTransformations3` / `customTransformations4`):**
| ad_id |
| :--- |
| 1 |
| 2 |
| 3 |
| 5 |

---

### **Step 4: Count Clicks per Ad**
The clicked data is grouped by `ad_id` and the number of occurrences is counted.

**Python Code:**
```python
customTransformations1 = customTransformations1.groupby('ad_id').size().reset_index(name='clicked_cnt')
```

**Table Output (`customTransformations5`):**
| ad_id | clicked_cnt |
| :--- | :--- |
| 1 | 2 |
| 2 | 1 |
| 3 | 1 |

---

### **Step 5: Count Views per Ad**
The viewed data is grouped by `ad_id` and the number of occurrences is counted.

**Python Code:**
```python
customTransformations2 = customTransformations2.groupby('ad_id').size().reset_index(name='viewed_cnt')
```

**Table Output (`customTransformations6`):**
| ad_id | viewed_cnt |
| :--- | :--- |
| 1 | 1 |
| 2 | 2 |
| 3 | 1 |

---

### **Step 6: Merge Counts and Calculate Raw CTR**
The click and view counts are merged using an outer join (ensuring no ads are lost yet). Missing values are filled with 0.
CTR is calculated as `Clicked / (Clicked + Viewed)`. Note that Ad 5 has 0 clicks and 0 views, resulting in `0/0`, which pandas treats as `NaN`.

**Python Code:**
```python
join1 = pd.merge(customTransformations5, customTransformations6, on='ad_id', how='outer')
join1['clicked_cnt'] = join1['clicked_cnt'].fillna(0)
join1['viewed_cnt'] = join1['viewed_cnt'].fillna(0)
join1['ctr'] = join1['clicked_cnt'] / (join1['clicked_cnt'] + join1['viewed_cnt'])
```

**Table Output (`customTransformations7`):**
| ad_id | clicked_cnt | viewed_cnt | ctr |
| :--- | :--- | :--- | :--- |
| 1 | 2 | 1 | 0.666666... |
| 2 | 1 | 2 | 0.333333... |
| 3 | 1 | 1 | 0.500000... |
| 5 | 0 | 0 | NaN |

---

### **Step 7: Merge with Unique Ad IDs**
The calculated metrics are joined with the master list of unique ad IDs (`customTransformations4`). This ensures Ad 5 is included in the output.

**Python Code:**
```python
join2 = pd.merge(customTransformations4, customTransformations7, on='ad_id', how='left')
```

**Table Output (`join2`):**
| ad_id | ctr |
| :--- | :--- |
| 1 | 0.666666... |
| 2 | 0.333333... |
| 3 | 0.500000... |
| 5 | NaN |

---

### **Step 8: Handle Missing Values and Round**
1. `NaN` values (from Ad 5) are replaced with 0.
2. The CTR is rounded to 4 decimal places using "half up" logic: `(ctr * 10000 + 0.5).astype(int) / 10000.0`.

**Python Code:**
```python
customTransformations8 = join2[['ad_id', 'ctr']]
customTransformations8['ctr'] = customTransformations8['ctr'].fillna(0)
customTransformations9['ctr'] = (customTransformations9['ctr'] * 10000 + 0.5).astype(int) / 10000.0
```

**Table Output (`customTransformations10`):**
| ad_id | ctr |
| :--- | :--- |
| 1 | 0.6667 |
| 2 | 0.3333 |
| 3 | 0.5000 |
| 5 | 0.0000 |

---

### **Step 9: Convert to Percentage**
The CTR is multiplied by 100 to convert the decimal to a percentage format.

**Python Code:**
```python
customTransformations10['ctr'] = customTransformations10['ctr'] * 100
```

**Table Output (`customTransformations11`):**
| ad_id | ctr |
| :--- | :--- |
| 1 | 66.67 |
| 2 | 33.33 |
| 3 | 50.00 |
| 5 | 0.00 |

---

### **Step 10: Sort and Final Output**
The data is sorted by `ctr` in descending order (highest percentage first), and then by `ad_id` in ascending order to break ties.

**Python Code:**
```python
output = customTransformations11.sort_values(['ctr', 'ad_id'], ascending=[False, True])
```

**Final Table Output:**
| ad_id | ctr |
| :--- | :--- |
| 1 | 66.67 |
| 3 | 50.00 |
| 2 | 33.33 |
| 5 | 0.00 |

