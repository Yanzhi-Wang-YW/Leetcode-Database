```md
1384. Total Sales Amount by Year  
Table: Product

+---------------+---------+
| Column Name   | Type    |
+---------------+---------+
| product_id    | int     |
| product_name  | varchar |
+---------------+---------+
product_id is the primary key (column with unique values) for this table.
product_name is the name of the product.
 

Table: Sales

+---------------------+---------+
| Column Name         | Type    |
+---------------------+---------+
| product_id          | int     |
| period_start        | date    |
| period_end          | date    |
| average_daily_sales | int     |
+---------------------+---------+
product_id is the primary key (column with unique values) for this table. 
period_start and period_end indicate the start and end date for the sales period, and both dates are inclusive.
The average_daily_sales column holds the average daily sales amount of the items for the period.
The dates of the sales years are between 2018 to 2020.
 

Write a solution to report the total sales amount of each item for each year, with corresponding product_name, product_id, report_year, and total_amount.

Return the result table ordered by product_id and report_year.

The result format is in the following example.

 

Example 1:

Input: 
Product table:
+------------+--------------+
| product_id | product_name |
+------------+--------------+
| 1          | LC Phone     |
| 2          | LC T-Shirt   |
| 3          | LC Keychain  |
+------------+--------------+
Sales table:
+------------+--------------+-------------+---------------------+
| product_id | period_start | period_end  | average_daily_sales |
+------------+--------------+-------------+---------------------+
| 1          | 2019-01-25   | 2019-02-28  | 100                 |
| 2          | 2018-12-01   | 2020-01-01  | 10                  |
| 3          | 2019-12-01   | 2020-01-31  | 1                   |
+------------+--------------+-------------+---------------------+
Output: 
+------------+--------------+-------------+--------------+
| product_id | product_name | report_year | total_amount |
+------------+--------------+-------------+--------------+
| 1          | LC Phone     |    2019     | 3500         |
| 2          | LC T-Shirt   |    2018     | 310          |
| 2          | LC T-Shirt   |    2019     | 3650         |
| 2          | LC T-Shirt   |    2020     | 10           |
| 3          | LC Keychain  |    2019     | 31           |
| 3          | LC Keychain  |    2020     | 31           |
+------------+--------------+-------------+--------------+
Explanation: 
LC Phone was sold for the period of 2019-01-25 to 2019-02-28, and there are 35 days for this period. Total amount 35*100 = 3500. 
LC T-shirt was sold for the period of 2018-12-01 to 2020-01-01, and there are 31, 365, 1 days for years 2018, 2019 and 2020 respectively.
LC Keychain was sold for the period of 2019-12-01 to 2020-01-31, and there are 31, 31 days for years 2019 and 2020 respectively
```

```py
import pandas as pd

def total_sales(product: pd.DataFrame, sales: pd.DataFrame) -> pd.DataFrame:
    output = product.merge(sales, how='inner', on='product_id') 
    output['days'] = output.apply(
        lambda r: pd.date_range(r['period_start'], r['period_end']), axis=1
    ) 
    output = output.explode('days') 
    output['report_year'] = pd.to_datetime(output['days']).dt.strftime('%Y') 
    output = output.groupby(['product_id', 'product_name', 'report_year']).agg(
       total_amount=('average_daily_sales', 'sum')  
    ).reset_index() 
    output = output.sort_values(['product_id', 'report_year'], ascending=[True, True])       
    return output 
```

 Here is the step-by-step table flowchart with the corresponding Python code for the `total_sales` function.

### **Step 1: Merge Product and Sales**
The `product` and `sales` DataFrames are joined using an inner join on `product_id`.

**Python Code:**
```python
output = product.merge(sales, how='inner', on='product_id')
```

**Table Output (`output`):**
| product_id | product_name | period_start | period_end | average_daily_sales |
| :--- | :--- | :--- | :--- | :--- |
| 1 | LC Phone | 2019-01-25 | 2019-02-28 | 100 |
| 2 | LC T-Shirt | 2018-12-01 | 2020-01-01 | 10 |
| 3 | LC Keychain | 2019-12-01 | 2020-01-31 | 1 |

---

### **Step 2: Generate Date Ranges**
For each row, a list of dates is generated from `period_start` to `period_end` (inclusive). These lists are stored in the new `days` column.

**Python Code:**
```python
output['days'] = output.apply(
    lambda r: pd.date_range(r['period_start'], r['period_end']), axis=1
)
```

**Table Output (`output`):**
*(Each cell in `days` contains a list of date objects)*
| product_id | product_name | period_start | period_end | average_daily_sales | **days** |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | LC Phone | 2019-01-25 | 2019-02-28 | 100 | [2019-01-25, 2019-01-26, ..., 2019-02-28] |
| 2 | LC T-Shirt | 2018-12-01 | 2020-01-01 | 10 | [2018-12-01, ..., 2019-12-31, 2020-01-01] |
| 3 | LC Keychain| 2019-12-01 | 2020-01-31 | 1 | [2019-12-01, ..., 2020-01-31] |

---

### **Step 3: Explode Dates**
The `days` column is "exploded". This means each list of dates is transformed into individual rows, duplicating the other column data for each date.

**Python Code:**
```python
output = output.explode('days')
```

**Table Output (`output`):**
*(Showing a subset of the rows for Product 2 as it spans multiple years)*
| product_id | product_name | average_daily_sales | days |
| :--- | :--- | :--- | :--- |
| 1 | LC Phone | 100 | 2019-01-25 |
| 1 | LC Phone | 100 | ... |
| 1 | LC Phone | 100 | 2019-02-28 |
| 2 | LC T-Shirt | 10 | 2018-12-01 |
| ... | ... | ... | ... |
| 2 | LC T-Shirt | 10 | 2019-12-31 |
| 2 | LC T-Shirt | 10 | **2020-01-01** |
| 3 | LC Keychain | 1 | 2019-12-01 |
| 3 | LC Keychain | 1 | ... |
| 3 | LC Keychain | 1 | 2020-01-31 |

---

### **Step 4: Extract Report Year**
The `days` column is converted to datetime format, and the year is extracted into a new `report_year` column.

**Python Code:**
```python
output['report_year'] = pd.to_datetime(output['days']).dt.strftime('%Y')
```

**Table Output (`output`):**
| product_id | product_name | average_daily_sales | days | **report_year** |
| :--- | :--- | :--- | :--- | :--- |
| 1 | LC Phone | 100 | 2019-01-25 | 2019 |
| ... | ... | ... | ... | 2019 |
| 2 | LC T-Shirt | 10 | 2019-12-31 | 2019 |
| 2 | LC T-Shirt | 10 | 2020-01-01 | **2020** |
| 3 | LC Keychain | 1 | 2019-12-01 | 2019 |
| ... | ... | ... | ... | 2020 |

---

### **Step 5: Aggregate Total Sales**
The data is grouped by `product_id`, `product_name`, and `report_year`. The `average_daily_sales` is summed for each group. Since every day contributes the `average_daily_sales` value, summing them gives the total sales for that period.

**Python Code:**
```python
output = output.groupby(['product_id', 'product_name', 'report_year']).agg(
   total_amount=('average_daily_sales', 'sum')
).reset_index()
```

**Table Output (`output`):**
*(Calculated based on the number of days in each year per product)*
| product_id | product_name | report_year | total_amount |
| :--- | :--- | :--- | :--- |
| 1 | LC Phone | 2019 | 3500 |
| 2 | LC T-Shirt | 2018 | 310 |
| 2 | LC T-Shirt | 2019 | 3650 |
| 2 | LC T-Shirt | 2020 | 10 |
| 3 | LC Keychain | 2019 | 31 |
| 3 | LC Keychain | 2020 | 31 |

---

### **Step 6: Sort and Final Output**
The final table is sorted by `product_id` and `report_year` in ascending order.

**Python Code:**
```python
output = output.sort_values(['product_id', 'report_year'], ascending=[True, True])
```

**Final Table Output:**
| product_id | product_name | report_year | total_amount |
| :--- | :--- | :--- | :--- |
| 1 | LC Phone | 2019 | 3500 |
| 2 | LC T-Shirt | 2018 | 310 |
| 2 | LC T-Shirt | 2019 | 3650 |
| 2 | LC T-Shirt | 2020 | 10 |
| 3 | LC Keychain | 2019 | 31 |
| 3 | LC Keychain | 2020 | 31 | 
